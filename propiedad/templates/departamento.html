{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<style>
        .upload-section {
        border: 2px dashed #dee2e6;
        border-radius: 15px;
        padding: 40px 20px;
        text-align: center;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }
    
    .upload-section::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 10px,
            rgba(0,123,255,0.03) 10px,
            rgba(0,123,255,0.03) 20px
        );
        animation: move 20s linear infinite;
    }
    
    @keyframes move {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    .upload-section:hover {
        border-color: #007bff;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,123,255,0.1);
    }
    
    .upload-section.dragover {
        border-color: #28a745;
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        transform: scale(1.02);
    }
    
    .upload-content {
        position: relative;
        z-index: 1;
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .upload-section:hover .upload-icon {
        color: #007bff;
        transform: scale(1.1);
    }
    
    /* Preview de archivos */
    .file-preview {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
        border-radius: 10px;
        background: white;
        padding: 15px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
    }
    
    .preview-item {
        margin-bottom: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        transition: transform 0.2s ease;
    }
    
    .preview-item:hover {
        transform: translateX(5px);
    }
    
    .preview-item img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 5px;
        margin-right: 10px;
    }
    
    /* Upload de video */
    .video-upload {
        border: 2px dashed #dc3545;
        border-radius: 10px;
        padding: 30px 20px;
        background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
        transition: all 0.3s ease;
    }
    
    .video-upload:hover {
        border-color: #c82333;
        background: linear-gradient(135deg, #ffe6e6 0%, #ffcccc 100%);
        transform: translateY(-2px);
    }
    
    /* Progress bar */
    .progress-text {
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    /* Animaciones */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .upload-section.processing {
        animation: pulse 2s infinite;
        border-color: #28a745;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .upload-section {
            padding: 30px 15px;
        }
        .upload-icon {
            font-size: 2rem;
        }
        .file-preview {
            max-height: 200px;
        }
    }
    .descripcion-textarea {
        height: 150px !important;
        resize: none;
    }
    .section-header {
        background: linear-gradient(to right, #ff5733, #ff8c00);
        color: white;
        padding: 10px;
        border-radius: 5px 5px 0 0;
        font-weight: bold;
    }
    .card {
        border: none;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }
</style>
<body class="bg-gradient-primary">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-xl-10 col-lg-12 col-md-9">
                <div class="text-center mt-4">
                    <h1 class="h3 text-gray-900">Registro de Departamento</h1>
                </div>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% if form.errors %}
                        <div class="alert alert-danger">
                            <ul>
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>{{ field|title }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    <div class="card o-hidden border-0 shadow-lg my-5">
                        <div class="section-header">General</div>
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="id_propietario">Propietario:</label>
                                        <!-- Campo de búsqueda dentro del contenedor del select -->
                                        <div class="select-search-container">
                                        <input type="text" id="propietario_search" class="form-control" placeholder="Buscar propietario...">
                                        </div>
                                        <br>
                                        <div class="d-flex">
                                            <div class="custom-select-container flex-grow-1 mr-2">                                                
                                                <!-- Select original -->
                                                <select name="id_propietario" id="id_propietario" class="custom-select">
                                                    <option value="">-------</option>
                                                    {% for propietario in propietarios %}
                                                        <option value="{{ propietario.id }}" {% if form.instance.id_propietario and form.instance.id_propietario.id == propietario.id %}selected{% endif %}>
                                                            {{ propietario.representante }} - {{ propietario.correo }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <a href="{% url 'propietarios:registrar_propietario' %}" class="btn btn-success align-self-center col-md-3">Crear</a>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.numero_rol.id_for_label }}">Número de Rol (SII)*</label>
                                        {{ form.numero_rol|add_class:"form-control" }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="{{ form.descripcion.id_for_label }}">Descripción*</label>
                                        {{ form.descripcion|add_class:"form-control descripcion-textarea" }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="{{ form.titulo.id_for_label }}">Título (hasta 100 caracteres)*</label>
                                        {{ form.titulo|add_class:"form-control" }}
                                    </div>
                                    <div class="form-group">
                                        <label for="id_nueva">¿Es una propiedad nueva?</label>
                                        <select name="nueva" id="id_nueva" class="custom-select">
                                            <option value="No">Opciones (Por defecto: "No")</option>
                                            {% for choice in form.nueva.field.choices %}
                                                <option value="{{ choice.0 }}" {% if form.nueva.value == choice.0 %}selected{% endif %}>
                                                    {{ choice.1 }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.codigo_propiedad.id_for_label }}">Codigo de propiedad</label>
                                        {{ form.codigo_propiedad|add_class:"form-control" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card o-hidden border-0 shadow-lg my-5">
                        <div class="section-header">Ubicación</div>
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Región*</label>
                                    <select name="region" id="region" class="custom-select">
                                        <option value="" selected="">---------</option>
                                      
                                        <option value="Metropolitana">Metropolitana</option>
                                      
                                        <option value="Antofagasta">Antofagasta</option>
                                      
                                        <option value="Araucanía">Araucanía</option>
                                      
                                        <option value="Arica y Parinacota">Arica y Parinacota</option>
                                      
                                        <option value="Atacama">Atacama</option>
                                      
                                        <option value="Aysén">Aysén</option>
                                      
                                        <option value="Bernardo Ohiggins">Bernardo Ohiggins</option>
                                      
                                        <option value="Biobío">Biobío</option>
                                      
                                        <option value="Coquimbo">Coquimbo</option>
                                      
                                        <option value="Los Lagos">Los Lagos</option>
                                      
                                        <option value="Los Ríos">Los Ríos</option>
                                      
                                        <option value="Magallanes">Magallanes</option>
                                      
                                        <option value="Maule">Maule</option>
                                      
                                        <option value="Ñuble">Ñuble</option>
                                      
                                        <option value="Tarapacá">Tarapacá</option>
                                      
                                        <option value="Valparaíso">Valparaíso</option>
                                      
                                      </select>
                                </div>
                                <div class="col-md-6">
                                    <label>Comuna*</label>
                                    <select name="comuna" id="comuna" class="custom-select">
                                        <option value="">Seleccione una región primero</option>
                                    </select>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Calle*</label>
                                    {{ form.calle|add_class:"form-control" }}
                                </div>
                                <div class="col-md-4">
                                    <label>Número Calle*</label>
                                    {{ form.numero_calle|add_class:"form-control" }}
                                </div>
                                <div class="col-md-4">
                                    <label>Número De Departamento*</label>
                                    {{ form.numero_casa|add_class:"form-control" }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card o-hidden border-0 shadow-lg my-5">
                        <div class="section-header">Información adicional</div>
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Superficie construida (m²)*</label>
                                    {{ form.superficie_construida|add_class:"form-control" }}
                                </div>
                                <div class="col-md-4">
                                    <label>Superficie terreno (m²)</label>
                                    {{ form.superficie_terreno|add_class:"form-control" }}
                                </div>
                                <div class="col-md-4">
                                    <label>Año de Construcción</label>
                                    {{ form.anio_construccion|add_class:"form-control" }}
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label>Gastos comunes</label>
                                    {{ form.gastos_comunes|add_class:"form-control" }}
                                </div>
                                <div class="col-md-4">
                                    <label>Dormitorios*</label>
                                    <select name="dormitorios" id="dormitorios" class="custom-select">
                                        <option value="">Seleccione una opción</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label>Baños*</label>
                                    <select name="banios" id="banios" class="custom-select">
                                        <option value="">Seleccione una opción</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label>Estacionamientos</label>
                                    <select name="estacionamiento" id="estacionamiento" class="custom-select">
                                        <option value="">Seleccione una opción</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label>Bodegas</label>
                                    <select name="bodegas" id="bodegas" class="custom-select">
                                        <option value="">Seleccione una opción</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group mt-3">
                                <label>Otros</label>
                                <div class="form-group border rounded p-3">
                                    <div class="row">
                                        {% for opcion in form.otros.field.queryset %}
                                            <div class="col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="otros" value="{{ opcion.id }}" id="otros_{{ opcion.id }}"
                                                        {% if opcion in form.otros.value %}checked{% endif %}>
                                                    <label class="form-check-label" for="otros_{{ opcion.id }}">
                                                        {{ opcion.nombre }}
                                                    </label>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Sección de imágenes y video -->
                    <div class="card o-hidden border-0 shadow-lg my-5">
    <div class="section-header">
        <i class="fas fa-camera mr-2"></i>Imágenes y Video
    </div>
    <div class="card-body p-4">
        
        <!-- 🔥 SUBIDA DE IMÁGENES MEJORADA -->
        <div class="row">
            <div class="col-lg-8">
                <h5 class="mb-3">
                    <i class="fas fa-images text-primary mr-2"></i>
                    Imágenes de la propiedad
                </h5>
                
                <div class="upload-section" id="imageUploadZone">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <h4 class="text-primary mb-2">Arrastra tus imágenes aquí</h4>
                        <p class="text-muted mb-3">o haz clic para seleccionar archivos</p>
                        
                        <input type="file" 
                               class="d-none" 
                               name="imagenes" 
                               id="imagenes" 
                               multiple 
                               accept="image/jpeg,image/jpg,image/png,image/webp">
                        
                        <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('imagenes').click()">
                            <i class="fas fa-plus mr-2"></i>Seleccionar Imágenes
                        </button>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                Formatos: JPG, PNG, WebP | Máximo: 15 imágenes | Tamaño max: 10MB c/u
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- 🔥 PREVIEW DE IMÁGENES SELECCIONADAS -->
                <div id="imagePreview" class="file-preview" style="display: none;">
                    <h6><i class="fas fa-eye mr-2"></i>Imágenes seleccionadas:</h6>
                    <div id="imageList" class="row"></div>
                    <div class="mt-2">
                        <small class="text-success">
                            <i class="fas fa-check-circle mr-1"></i>
                            <span id="imageCount">0</span> imagen(es) lista(s) para subir
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- 🔥 SUBIDA DE VIDEO MEJORADA -->
            <div class="col-lg-4">
                <h5 class="mb-3">
                    <i class="fas fa-video text-danger mr-2"></i>
                    Video (Opcional)
                </h5>
                
                <div class="video-upload">
                    <div class="text-center">
                        <i class="fas fa-video fa-2x text-danger mb-3"></i>
                        <p class="text-muted mb-3">Sube un video de la propiedad</p>
                        
                        <input type="file" 
                               class="form-control-file d-none" 
                               name="video" 
                               id="video" 
                               accept="video/mp4,video/webm,video/mov,video/avi">
                        
                        <button type="button" class="btn btn-outline-danger" onclick="document.getElementById('video').click()">
                            <i class="fas fa-upload mr-2"></i>Seleccionar Video
                        </button>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                Formatos: MP4, WebM, MOV<br>
                                Tamaño máximo: 100MB
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Preview del video -->
                <div id="videoPreview" style="display: none;" class="mt-3">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-film mr-2"></i>Video seleccionado:</h6>
                        <p class="mb-1"><strong id="videoFileName"></strong></p>
                        <small class="text-muted" id="videoFileSize"></small>
                        <button type="button" class="btn btn-sm btn-outline-danger ml-2" onclick="removeVideo()">
                            <i class="fas fa-times"></i> Quitar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 🔥 PROGRESS BAR para upload -->
        <div id="uploadProgress" class="mt-4" style="display: none;">
            <h6><i class="fas fa-upload mr-2"></i>Preparando archivos...</h6>
            <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                     role="progressbar" 
                     style="width: 0%">
                    <span class="progress-text">0%</span>
                </div>
            </div>
            <small class="text-muted mt-1">Los archivos se subirán a Cloudinary automáticamente</small>
        </div>

        <!-- 🔥 CONSEJOS PARA MEJORES FOTOS -->
        <div class="mt-4">
            <div class="card bg-light">
                <div class="card-body py-3">
                    <h6 class="text-primary mb-2">
                        <i class="fas fa-lightbulb mr-2"></i>Consejos para mejores fotos
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                • Toma fotos con buena iluminación natural<br>
                                • Incluye exteriores e interiores<br>
                                • Muestra los espacios principales
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                • Evita objetos personales en las fotos<br>
                                • Toma fotos horizontales cuando sea posible<br>
                                • La primera imagen será la principal
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                                <div class="d-grid gap-2 col-12 mx-auto mt-4">
                                    <button class="btn btn-primary btn-user btn-block" type="submit">Registrar Propiedad</button>
                                </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const comunasPorRegion = {
                "Metropolitana": ["Santiago", "Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipú", "Ñuñoa", "Pedro Aguirre Cerda", "Peñalolén", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaquín", "San Miguel", "San Ramón", "Vitacura", "Colina", "Lampa", "Tiltil", "Puente Alto", "Pirque", "San José de Maipo", "San Bernardo", "Buin", "Paine", "Calera de Tango", "Melipilla", "Alhué", "Curacaví", "María Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Peñaflor"],
                "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollagüe", "San Pedro de Atacama", "Tocopilla", "María Elena"],
                "Araucanía": ["Temuco", "Carahue", "Cholchol", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre Las Casas", "Perquenco", "Pitrufquén", "Pucón", "Puerto Saavedra", "Teodoro Schmidt", "Toltén", "Vilcún", "Villarrica", "Angol", "Collipulli", "Curacautín", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Purén", "Renaico", "Traiguén", "Victoria"],
                "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"],
                "Atacama": ["Copiapó", "Caldera", "Tierra Amarilla", "Chañaral", "Diego de Almagro", "Vallenar", "Huasco", "Freirina", "Alto del Carmen"],
                "Aysén": ["Coyhaique", "Lago Verde", "Aysén", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "Río Ibáñez"],
                "Bernardo Ohiggins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Doñihue", "Graneros", "Las Cabras", "Machalí", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requínoa", "San Vicente", "San Fernando", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz", "Chépica", "Pichilemu", "La Estrella", "Litueche", "Marchigüe", "Navidad", "Paredones"],
                "Biobío": ["Concepción", "Coronel", "Chiguayante", "Florida", "Hualpén", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tomé", "Lebu", "Arauco", "Cañete", "Contulmo", "Curanilahue", "Los Álamos", "Tirúa", "Los Ángeles", "Antuco", "Cabrero", "Laja", "Mulchén", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa Bárbara", "Tucapel", "Yumbel", "Alto Biobío"],
                "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paihuano", "Vicuña", "Ovalle", "Combarbalá", "Monte Patria", "Punitaqui", "Río Hurtado", "Illapel", "Canela", "Los Vilos", "Salamanca"],
                "Los Lagos": ["Puerto Montt", "Calbuco", "Cochamó", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maullín", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de Vélez", "Dalcahue", "Puqueldón", "Queilén", "Quellón", "Quemchi", "Quinchao"],
                "Los Ríos": ["Valdivia", "Corral", "Lanco", "Los Lagos", "Máfil", "Mariquina", "Paillaco", "Panguipulli", "La Unión", "Futrono", "Lago Ranco", "Río Bueno"],
                "Magallanes": ["Punta Arenas", "Laguna Blanca", "Río Verde", "San Gregorio", "Cabo de Hornos", "Antártica", "Puerto Natales", "Torres del Paine"],
                "Maule": ["Talca", "Constitución", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "Río Claro", "San Clemente", "San Rafael", "Curicó", "Hualañé", "Licantén", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuquén"],
                "Ñuble": ["Chillán", "Bulnes", "Cobquecura", "Coelemu", "Coihueco", "El Carmen", "Ninhue", "Ñiquén", "Pemuco", "Pinto", "Portezuelo", "Quillón", "Quirihue", "Ránquil", "San Carlos", "San Fabián", "San Ignacio", "San Nicolás", "Treguaco", "Yungay"],
                "Tarapacá": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Camiña", "Colchane", "Huara", "Pica"],
                "Valparaíso": ["Valparaíso", "Viña del Mar", "Concón", "Quintero", "Puchuncaví", "Casablanca", "Juan Fernández", "Quilpué", "Villa Alemana", "Limache", "Olmué", "Quillota", "La Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Cartagena", "El Quisco", "El Tabo", "Algarrobo", "Santo Domingo", "San Felipe", "Llaillay", "Putaendo", "Santa María", "Catemu", "Panquehue", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar"],
                "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"],
            };
    
            document.getElementById("region").addEventListener("change", function () {
                let region = this.value;
                let comunaSelect = document.getElementById("comuna");
                comunaSelect.innerHTML = '<option value="">Seleccione una comuna</option>';
                if (region in comunasPorRegion) {
                    comunasPorRegion[region].forEach(comuna => {
                        let option = document.createElement("option");
                        option.value = comuna;
                        option.textContent = comuna;
                        comunaSelect.appendChild(option);
                    });
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('propietario_search');
            const selectElement = document.getElementById('id_propietario');
            
            // Función para filtrar las opciones del select
            searchInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase();
                const options = selectElement.options;
                
                for (let i = 0; i < options.length; i++) {
                    const option = options[i];
                    const optionText = option.text.toLowerCase();
                    
                    // Mostrar u ocultar la opción según si coincide con el texto de búsqueda
                    if (optionText.includes(searchText) || option.value === '') {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                }
            });
            
            // Limpiar el campo de búsqueda cuando cambia el select
            selectElement.addEventListener('change', function() {
                searchInput.value = '';
                // Mostrar todas las opciones nuevamente
                const options = selectElement.options;
                for (let i = 0; i < options.length; i++) {
                    options[i].style.display = '';
                }
            });
        });
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // 🔥 ELEMENTOS DEL DOM
    const imageInput = document.getElementById('imagenes');
    const videoInput = document.getElementById('video');
    const imageUploadZone = document.getElementById('imageUploadZone');
    const imagePreview = document.getElementById('imagePreview');
    const imageList = document.getElementById('imageList');
    const videoPreview = document.getElementById('videoPreview');
    const videoFileName = document.getElementById('videoFileName');
    const videoFileSize = document.getElementById('videoFileSize');
    const imageCount = document.getElementById('imageCount');
    
    let selectedImages = [];
    let selectedVideo = null;
    
    // 🔥 DRAG & DROP para imágenes
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        imageUploadZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        imageUploadZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        imageUploadZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        imageUploadZone.classList.add('dragover');
    }
    
    function unhighlight() {
        imageUploadZone.classList.remove('dragover');
    }
    
    imageUploadZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleImageFiles(files);
    }
    
    // Click en zona de upload
    imageUploadZone.addEventListener('click', function(e) {
        if (e.target === imageUploadZone || e.target.closest('.upload-content')) {
            imageInput.click();
        }
    });
    
    // 🔥 MANEJO DE SELECCIÓN DE IMÁGENES
    imageInput.addEventListener('change', function(e) {
        handleImageFiles(e.target.files);
    });
    
    function handleImageFiles(files) {
        // Validar número máximo de archivos
        if (files.length > 15) {
            alert('⚠️ Máximo 15 imágenes permitidas. Se seleccionarán las primeras 15.');
            files = Array.from(files).slice(0, 15);
        }
        
        selectedImages = [];
        imageList.innerHTML = '';
        
        if (files.length === 0) {
            imagePreview.style.display = 'none';
            return;
        }
        
        imagePreview.style.display = 'block';
        
        Array.from(files).forEach((file, index) => {
            if (!file.type.startsWith('image/')) {
                console.warn(`Archivo ${file.name} no es una imagen válida`);
                return;
            }
            
            // Validar tamaño
            if (file.size > 10 * 1024 * 1024) { // 10MB
                alert(`⚠️ La imagen "${file.name}" es muy grande. Máximo 10MB por imagen.`);
                return;
            }
            
            selectedImages.push(file);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const colDiv = document.createElement('div');
                colDiv.className = 'col-md-6 col-lg-4 mb-2';
                
                colDiv.innerHTML = `
                    <div class="preview-item d-flex align-items-center">
                        <img src="${e.target.result}" alt="Preview">
                        <div class="flex-grow-1">
                            <div class="text-truncate" style="max-width: 150px;">
                                <strong>${file.name}</strong>
                            </div>
                            <small class="text-muted">${formatFileSize(file.size)}</small>
                            ${index === 0 ? '<br><small class="text-primary"><i class="fas fa-star"></i> Imagen principal</small>' : ''}
                        </div>
                        <div class="text-success ml-2">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                `;
                imageList.appendChild(colDiv);
            };
            reader.readAsDataURL(file);
        });
        
        // Actualizar contador
        imageCount.textContent = selectedImages.length;
        
        // Actualizar el input file con los archivos seleccionados
        const dt = new DataTransfer();
        selectedImages.forEach(file => dt.items.add(file));
        imageInput.files = dt.files;
    }
    
    // 🔥 MANEJO DE VIDEO
    videoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validar tamaño
            if (file.size > 100 * 1024 * 1024) { // 100MB
                alert('⚠️ El video es muy grande. Máximo 100MB.');
                this.value = '';
                videoPreview.style.display = 'none';
                selectedVideo = null;
                return;
            }
            
            selectedVideo = file;
            videoFileName.textContent = file.name;
            videoFileSize.textContent = formatFileSize(file.size);
            videoPreview.style.display = 'block';
        } else {
            videoPreview.style.display = 'none';
            selectedVideo = null;
        }
    });
    
    // 🔥 QUITAR VIDEO
    window.removeVideo = function() {
        videoInput.value = '';
        videoPreview.style.display = 'none';
        selectedVideo = null;
    };
    
    // 🔥 FORMATO DE TAMAÑO DE ARCHIVO
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // 🔥 VALIDACIÓN AL ENVIAR EL FORMULARIO
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = progressContainer.querySelector('.progress-bar');
            const progressText = progressContainer.querySelector('.progress-text');
            
            // Mostrar progress bar
            progressContainer.style.display = 'block';
            imageUploadZone.classList.add('processing');
            
            // Simular progreso
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 95) progress = 95;
                
                progressBar.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
                
                if (progress >= 95) {
                    clearInterval(interval);
                    progressText.textContent = 'Finalizando...';
                }
            }, 200);
        });
    }
});
</script>
</body>
{% endblock %}
