{% extends "base.html" %}
{% block content %}
{% load humanize %}
{% load cloudinary %}

<div class="container mt-5">
    <div class="card shadow-lg p-4">
        <div class="card-body">
            <h2 class="text-primary mb-4">Listado de Propiedades</h2>
            
            <!-- Filtro por comuna -->
            <div class="d-flex flex-column flex-sm-row gap-3 mb-4">
                <input type="text" id="filtroComuna" class="form-control flex-grow-1" placeholder="Filtrar: Comuna">
                <input type="text" id="filtroCodigo" class="form-control flex-grow-1" placeholder="Filtrar: Código de propiedad">
                <select name="nueva" id="filtroPropiedadNueva" class="form-control flex-grow-1" aria-label="Nueva">
                    <option value="" selected>Nueva: Sí o No</option>
                    <option value="Sí">Sí</option>
                    <option value="No">No</option>
                </select>
                <select name="tipo" id="filtroTipoPropiedad" class="form-control flex-grow-1" aria-label="Tipo">
                    <option value="" selected>Tipo de propiedad</option>
                    <option value="Casa">Casa</option>
                    <option value="Departamento">Departamento</option>
                    <option value="Oficina">Oficina</option>
                    <option value="Local Industrial">Local Industrial</option>
                    <option value="Bodega">Bodega</option>
                    <option value="Local Comercial">Local Comercial</option>
                    <option value="Terreno">Terreno</option>
                    <option value="Parcela">Parcela</option>
                </select>
                <a href="{% url 'propiedad:agregar_propiedad' %}" class="btn btn-success flex-grow-1">Crear</a>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered text-center">
                    <thead class="thead-light">
                        <tr>
                            <th>FOTO</th>
                            <th>TITULO</th>
                            <th>CODIGO</th>
                            <th>COMUNA</th>
                            <th>NUMERO ROL</th>
                            <th>NUEVA</th>
                            <th>FECHA DE CREACIÓN</th>
                            <th>ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for propiedad in propiedades %}
                        <tr data-tipo="{{ propiedad.tipo_propiedad }}">
                            <td>
                                {% if propiedad.imagenes.exists %}
                                    {% with primera_imagen=propiedad.imagenes.first %}
                                        {% cloudinary primera_imagen.imagen width=50 height=50 crop="fill" class="img-thumbnail preview-img cursor-pointer" %}
                                    {% endwith %}
                                {% else %}
                                    <img src="https://via.placeholder.com/50x50/cccccc/666666?text=Sin+Foto" 
                                         class="img-thumbnail property-thumbnail" width="50" height="50">
                                {% endif %}
                            </td>
                            <td>{{ propiedad.titulo|truncatechars:15 }}</td>
                            <td>{{ propiedad.codigo_propiedad }}</td>
                            <td>{{ propiedad.comuna }}</td>
                            <td>{{ propiedad.numero_rol }}</td>
                            <td>{{ propiedad.nueva }}</td>
                            <td>{{ propiedad.fecha_creacion }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{% url 'propiedad:descripcion_propiedad' propiedad.id %}" class="btn btn-secondary btn-sm">Detalles</a>
                                    <a href="{% url 'documentos:mostrar_documentos' propiedad.id %}" class="btn btn-info btn-sm">Documentos</a>
                                    <a href="{% url 'propiedad:modificar_propiedad' propiedad.id %}" class="btn btn-warning btn-sm">Modificar</a>
                                    <a href="{% url 'propiedad:eliminar_propiedad' propiedad.id %}" class="btn btn-danger btn-sm">Eliminar</a>
                                    <a href="{% url 'operaciones:crear_operacion_venta' propiedad.id %}" class="btn btn-success btn-sm">Iniciar operación</a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">No hay propiedades registradas.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualizar imagen en grande -->
<div class="modal fade" id="imagenModal" tabindex="-1" aria-labelledby="imagenModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagenModalLabel">Vista Previa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imagenAmpliada" src="" class="img-fluid rounded shadow modal-image" loading="lazy">
            </div>
        </div>
    </div>
</div>

<!-- Estilos Personalizados -->
<style>
    .table th, .table td {
        vertical-align: middle;
    }
    .btn-group .btn {
        border-radius: 5px;
        margin: 0 1px;
    }
    
    /* Estilos para las imágenes thumbnail - ajustadas al contenedor */
    .img-thumbnail {
        border-radius: 5px;
        cursor: pointer;
        object-fit: contain; /* Cambiado de 'cover' a 'contain' */
        background-color: #f8f9fa; /* Color de fondo para espacios vacíos */
        transition: transform 0.2s ease;
        width: 50px;
        height: 50px;
    }
    
    .img-thumbnail:hover {
        transform: scale(1.05);
    }
    
    .cursor-pointer {
        cursor: pointer;
    }
    
    /* Estilos para la imagen en el modal - también ajustada */
    .modal-image {
        max-width: 100%;
        max-height: 70vh; /* Limitar altura del modal */
        object-fit: contain; /* La imagen se ajusta sin cortarse */
        background-color: #f8f9fa; /* Color de fondo consistente */
    }
    
    /* Asegurar que las imágenes placeholder también se ajusten */
    .property-thumbnail {
        object-fit: contain;
        background-color: #f8f9fa;
    }
    
    /* Responsive para botones en móviles */
    @media (max-width: 768px) {
        .btn-group {
            flex-direction: column;
        }
        .btn-group .btn {
            margin: 1px 0;
            font-size: 0.8rem;
        }
    }
</style>

<!-- JavaScript para filtros y modal -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Obtener elementos de filtro
    const filtroNueva = document.getElementById("filtroPropiedadNueva");
    const filtroTipo = document.getElementById("filtroTipoPropiedad");
    const filtroComuna = document.getElementById("filtroComuna");
    const filtroCodigo = document.getElementById("filtroCodigo");
    
    // Función para aplicar todos los filtros
    function aplicarFiltros() {
        const valorFiltroNueva = filtroNueva.value;
        const valorFiltroTipo = filtroTipo.value;
        const valorFiltroComuna = filtroComuna.value.toLowerCase();
        const valorFiltroCodigo = filtroCodigo.value.toLowerCase();
        
        const filas = document.querySelectorAll("tbody tr");
        
        filas.forEach(fila => {
            // Si es la fila de "No hay propiedades", ignorarla
            if (fila.cells.length <= 1) return;
            
            const valorNueva = fila.querySelector("td:nth-child(6)").textContent.trim();
            const valorTipo = fila.getAttribute('data-tipo') || "";
            const valorComuna = fila.querySelector("td:nth-child(4)").textContent.trim().toLowerCase();
            const valorCodigo = fila.querySelector("td:nth-child(3)").textContent.trim().toLowerCase();
            
            // Mostrar filas que cumplan con todos los filtros
            const cumpleFiltroNueva = valorFiltroNueva === "" || valorNueva === valorFiltroNueva;
            const cumpleFiltroTipo = valorFiltroTipo === "" || valorTipo === valorFiltroTipo;
            const cumpleFiltroComuna = valorFiltroComuna === "" || valorComuna.includes(valorFiltroComuna);
            const cumpleFiltroCodigo = valorFiltroCodigo === "" || valorCodigo.includes(valorFiltroCodigo);
            
            if (cumpleFiltroNueva && cumpleFiltroTipo && cumpleFiltroComuna && cumpleFiltroCodigo) {
                fila.style.display = "";
            } else {
                fila.style.display = "none";
            }
        });
    }
    
    // Agregar event listeners a todos los filtros
    filtroNueva.addEventListener("change", aplicarFiltros);
    filtroTipo.addEventListener("change", aplicarFiltros);
    filtroComuna.addEventListener("input", aplicarFiltros);
    filtroCodigo.addEventListener("input", aplicarFiltros);
    
    // Funcionalidad del modal para las imágenes
    document.querySelectorAll('.preview-img').forEach(img => {
        img.addEventListener('click', function() {
            // Obtener la URL de la imagen desde Cloudinary
            const imageUrl = this.src;
            // Crear una versión de mayor resolución para el modal
            const highResUrl = imageUrl.replace(/w_50,h_50/, 'w_800,h_600');
            
            document.getElementById('imagenAmpliada').setAttribute('src', highResUrl);
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('imagenModal'));
            modal.show();
        });
    });
});
</script>

{% endblock %}